# openai_integration.py

import http.client
import json
from config import get_api_credentials
import streamlit as st

def get_openai_response(prompt):
    openai_api_scheme, openai_api_host, openai_api_key = get_api_credentials()

    geoinfo = st.session_state.get('geoinfo', '未知区域')  # 获取 geoinfo 或者使用默认值

    conn = http.client.HTTPConnection(openai_api_host)
    if openai_api_scheme == "https":
        conn = http.client.HTTPSConnection(openai_api_host)

    system_content = "用中文回答问题。"
    if geoinfo:
        system_content += f" 地理编码: {geoinfo}，这个地理编码包含了大洲、城市、国家以及下属行政规划和具体城市的信息，举个例子，WMO_Region_2_Asia/CHN_China/SN_Shaanxi/CHN_SN_Xian.570360_CSWD代表着亚洲中国陕西省西安市，在对该地区进行分析时要结合地理编码所包含的地理信息进行分析"

    payload = json.dumps({
        "model": "gpt-4o-mini",
        "messages": [
            {"role": "system", "content": system_content},
            {"role": "user", "content": prompt}
        ],
        "temperature": 0
    })
    headers = {
        'Authorization': f'Bearer {openai_api_key}',
        'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
        'Content-Type': 'application/json'
    }
    conn.request("POST", "/v1/chat/completions", payload, headers)
    res = conn.getresponse()
    data = json.loads(res.read().decode("utf-8"))

    if "choices" not in data:
        return "服务器繁忙或出现错误，请重试/The server is busy or experiencing errors, please try again"

    content = data["choices"][0]["message"]["content"]
    return content

def generate_passive_strategies_advice(chart_text):
    """
    生成被动式策略建议。

    Args:
        chart_text (str): 图表文本信息。

    Returns:
        str: 被动式策略建议。
    """
    prompt = (f"在你进行内容输出时，应当让语言尽可能自然，不要机械式的介绍和分析，你现在是一个研究建筑被动式策略的专家，当前城市焓湿图计算结果如下：{chart_text}，请先根据你已知的信息，分享这座城市的信息，包括大洲、国家、行政区划和城市名（中文或翻译成中文），你在输出时请使用自然语言，不要出现地理编码信息，并从地理学的角度介绍这座城市的信息"
              "你需要针对这些数据提供对于该地区建筑采取被动式策略的具体建议,同时将这些策略中占比时长前六的策略借由占比时长从长到短依次排列，"
              "且对其进行有关具体措施的介绍。"
              "你的输出格式应该为：{city_name}市位于{continent_name}州{country_name}国{region_name}省/其他行政区，其气候特点和地理特点为{information}，以下为分析结果：{result}"
              )
              
    return get_openai_response(prompt)

def generate_temperature_analysis_advice(monthly_text, daily_text):
    """
    生成气温数据分析建议。

    Args:
        monthly_text (str): 月数据文本信息。
        daily_text (str): 日数据文本信息。

    Returns:
        str: 气温数据分析建议。
    """
    prompt = (f"在你进行内容输出时，应当让语言尽可能自然，不要机械式的介绍和分析，你现在是一个从事绿色建筑相关专业的气候数据分析师，当前月份的气温数据和该城市全年的气温数据如下：{daily_text}，{monthly_text}，请先根据你已知的信息，分享这座城市的信息，包括大洲、国家、行政区划和城市名（中文或翻译成中文），你在输出时请使用自然语言，不要出现地理编码信息，并从地理学的角度介绍这座城市的信息"
              "请你以以上数据为基础详略得当的介绍当前月份的气温与该城市全年的气温，将当前月份气温与全年气温相对比，并指出这些数据如何影响当地建筑设计，"
              "注意，如果属于某种温度的月份有0个月，则将其忽略。"
              "你的输出格式应该为：{city_name}市位于{continent_name}州{country_name}国{region_name}省/其他行政区，其气候特点和地理特点为{information}，以下为分析结果：{result}"
              )
              
    return get_openai_response(prompt)

def generate_humidity_analysis_advice(monthly_text, daily_text):
    """
    生成相对湿度数据分析建议。

    Args:
        monthly_text (str): 月数据文本信息。
        daily_text (str): 日数据文本信息。

    Returns:
        str: 相对湿度数据分析建议。
    """
    prompt = (f"在你进行内容输出时，应当让语言尽可能自然，不要机械式的介绍和分析，你现在是一个从事绿色建筑相关专业的气候数据分析师，当前月份的相对湿度数据和该城市全年的相对湿度数据如下：{daily_text}，{monthly_text}，请先根据你已知的信息，分享这座城市的信息，包括大洲、国家、行政区划和城市名（中文或翻译成中文），你在输出时请使用自然语言，不要出现地理编码信息，并从地理学的角度介绍这座城市的信息"
              "请你以以上数据为基础详略得当的介绍当前月份的相对湿度与该城市全年的相对湿度，将当前月份相对湿度与全年相对比，"
              "并指出这些数据如何影响当地建筑设计。"
              "你的输出格式应该为：{city_name}市位于{continent_name}州{country_name}国{region_name}省/其他行政区，其气候特点和地理特点为{information}，以下为分析结果：{result}"
              )
              
    return get_openai_response(prompt)

def generate_wind_analysis_advice(monthly_text, daily_text, prevailing_direction_month, prevailing_direction_year):
    """
    生成风速和风向数据分析建议。

    Args:
        monthly_text (str): 月数据文本信息。
        daily_text (str): 日数据文本信息。
        prevailing_direction_month (str): 当前月份的盛行风向。
        prevailing_direction_year (str): 全年的盛行风向。

    Returns:
        str: 风速和风向数据分析建议。
    """
    prompt = (f"在你进行内容输出时，应当让语言尽可能自然，不要机械式的介绍和分析，你现在是一个从事绿色建筑相关专业的气候数据分析师，当前月份的风速和该城市全年的风速数据如下：{daily_text}，{monthly_text}，请先根据你已知的信息，分享这座城市的信息，包括大洲、国家、行政区划和城市名（中文或翻译成中文），你在输出时请使用自然语言，不要出现地理编码信息，并从地理学的角度介绍这座城市的信息"
              f"同时当前月份的盛行风向为{prevailing_direction_month}，全年的盛行风向为{prevailing_direction_year}，"
              "请你以以上数据为基础详略得当的介绍当前月份的风速风向与该城市全年的风速风向，将当前月份风速风向与全年风速风向对比，"
              "并指出这些数据如何影响当地建筑设计。"
              "你的输出格式应该为：{city_name}市位于{continent_name}州{country_name}国{region_name}省/其他行政区，其气候特点和地理特点为{information}，以下为分析结果：{result}"
              )
              
    return get_openai_response(prompt)

def generate_sky_cover_analysis_advice(monthly_text, daily_text):
    """
    生成天空覆盖量数据分析建议。

    Args:
        monthly_text (str): 月数据文本信息。
        daily_text (str): 日数据文本信息。

    Returns:
        str: 天空覆盖量数据分析建议。
    """
    prompt = (f"在你进行内容输出时，应当让语言尽可能自然，不要机械式的介绍和分析，你现在是一个从事绿色建筑相关专业的气候数据分析师，当前月份的天空覆盖量数据和该城市全年的天空覆盖量数据如下：{daily_text}，{monthly_text}，请先根据你已知的信息，分享这座城市的信息，包括大洲、国家、行政区划和城市名（中文或翻译成中文），你在输出时请使用自然语言，不要出现地理编码信息，并从地理学的角度介绍这座城市的信息"
              "请你以以上数据为基础详略得当的介绍当前月份的天空覆盖量与该城市全年的天空覆盖量，将当前月份天空覆盖量与全年天空覆盖量相对比，"
              "并指出这些数据如何影响当地建筑设计。"
              "你的输出格式应该为：{city_name}市位于{continent_name}州{country_name}国{region_name}省/其他行政区，其气候特点和地理特点为{information}，以下为分析结果：{result}"
              )
              
    return get_openai_response(prompt)

def generate_radiation_analysis_advice(monthly_text, daily_text, type):
    """
    生成辐射数据分析建议。

    Args:
        monthly_text (str): 月数据文本信息。
        daily_text (str): 日数据文本信息。
        type (str): 辐射类型（"Direct" 或 "Diffuse" 或 "Global"）。

    Returns:
        str: 辐射数据分析建议。
    """
    prompt = (f"在你进行内容输出时，应当让语言尽可能自然，不要机械式的介绍和分析，你现在是一个从事绿色建筑相关专业的气候数据分析师，当前月份的{type}辐射数据和该城市全年的{type}辐射数据如下：{daily_text}，{monthly_text}，请先根据你已知的信息，分享这座城市的信息，包括大洲、国家、行政区划和城市名（中文或翻译成中文），你在输出时请使用自然语言，不要出现地理编码信息，并从地理学的角度介绍这座城市的信息"
              f"请你以以上数据为基础详略得当的介绍当前月份的{type}辐射与该城市全年的{type}辐射，将当前月份{type}辐射与全年{type}辐射相对比，"
              "并指出这些数据如何影响当地建筑设计。"
              "你的输出格式应该为：{city_name}市位于{continent_name}州{country_name}国{region_name}省/其他行政区，其气候特点和地理特点为{information}，以下为分析结果：{result}"
              )
              
    return get_openai_response(prompt)

def generate_illuminance_analysis_advice(monthly_text, daily_text, type):
    """
    生成照度数据分析建议。

    Args:
        monthly_text (str): 月数据文本信息。
        daily_text (str): 日数据文本信息。
        type (str): 照度类型（"Direct" 或 "Diffuse" 或 "Global"）。

    Returns:
        str: 照度数据分析建议。
    """
    prompt = (f"在你进行内容输出时，应当让语言尽可能自然，不要机械式的介绍和分析，你现在是一个从事绿色建筑相关专业的气候数据分析师，当前月份的{type}照度数据和该城市全年的{type}照度数据如下：{daily_text}，{monthly_text}，请先根据你已知的信息，分享这座城市的信息，包括大洲、国家、行政区划和城市名（中文或翻译成中文），你在输出时请使用自然语言，不要出现地理编码信息，并从地理学的角度介绍这座城市的信息"
              f"请你以以上数据为基础详略得当的介绍当前月份的{type}照度与该城市全年的{type}照度，将当前月份{type}照度与全年{type}照度相对比，"
              "并指出这些数据如何影响当地建筑设计。"
              "你的输出格式应该为：{city_name}市位于{continent_name}州{country_name}国{region_name}省/其他行政区，其气候特点和地理特点为{information}，以下为分析结果：{result}"
              )
              
    return get_openai_response(prompt)

def generate_summary(summary):
    """
    生成完整的分析建议。

    """
    prompt = (
            f"你现在是一个从事绿色建筑相关专业的气候数据分析师，结合地理编码你已经知道了这个城市的国家、行政区和城市名称city_name等信息，请将这些信息转换成中文，目前我们经过计算得到的数据包括{summary}"

            "请根据你已知的信息生成九页介绍文本，内容包括：\n\n"
            "第一页：城市的基本信息。请详细介绍{city_name}市所在的国家与行政规划、其所属气候区、所处纬度情况、温度降水情况、地形地貌情况，以及这些因素如何相互作用影响城市的气候特征，强调本地区的独特性和多样性，字数控制在200字以内。\n\n"
            "第二页：被动式策略总述。请以markdown表格的形式介绍该城市所属气候环境中所能采取的重要的被动式策略的占比，包括各策略的定义、适用性及其在当地建筑设计中的应用潜力，突出这些策略的有效性与可持续性。\n\n"
            "第三页：被动式策略详述。请结合被动式策略的方式方法、地区人文与民俗特色、气候环境、生物多样性等多方面因素，详细介绍该城市所属气候环境中所能采取的重要的被动式策略的具体方式，诸如使用环保材料、优化自然通风、巧妙控制日照等，强调这些策略在提升居住舒适度和能效方面的显著效果，字数控制在400字以内。\n\n"
            "第四页：气温环境介绍。通过已有数据介绍{city_name}市的气温环境，包括年平均气温、极端气温等，并衍生出针对气温环境如何对当地绿色建筑的实施与发展造成影响，探讨人们可以用哪些灵活的方式来应对气温变化的挑战，顺应自然条件，提升建筑的能效和舒适度，字数控制在3400字以内。\n\n"
            "第五页：湿度环境介绍。通过已有数据介绍{city_name}市的湿度环境，包括年平均湿度、湿度变化趋势等，并衍生出针对湿度环境如何对当地绿色建筑的实施与发展造成影响，讨论人们可以用哪些有效的方式来应对湿度变化的挑战，顺应自然条件，确保建筑的健康与舒适，字数控制在400字以内。\n\n"
            "第六页：风环境介绍。通过已有数据介绍{city_name}市的风环境，包括风速、盛行风向及其变化特征，并衍生出针对风环境如何对当地绿色建筑的实施与发展造成影响，探讨人们可以利用自然通风、优化建筑形态等方式来有效应对风环境带来的挑战，提升建筑的舒适性与能效，字数控制在400字以内。\n\n"
            "第七页：天空环境介绍。通过已有数据介绍{city_name}市的天空覆盖率、日照时数等，并衍生出针对天空覆盖率如何对当地绿色建筑的实施与发展造成影响，讨论人们可以通过巧妙的建筑设计来优化自然采光、提升建筑的能效，顺应自然条件，营造和谐的居住环境，字数控制在400字以内。"
            "第八页：日照辐射介绍。通过已有数据介绍{city_name}市的日照辐射情况，包括年均辐射量、日照时数等，并分析这些因素如何影响建筑设计和能源利用，探讨人们可以采取哪些措施来最大化日照利用，促进可持续发展，字数控制在300字以内。\n\n"  
            "第九页：照度介绍。通过已有数据介绍{city_name}市的照度水平，包括自然光照度的变化规律，并探讨照度对建筑内部环境、居住舒适度的影响，讨论人们可以如何通过设计和材料选择来优化照度，提升建筑的能效和舒适性，字数控制在300字以内。""以下为一个分析的模板，请严格按照模板的格式进行输出"
            
            "**城市的基本信息/Basic City Information**\n"
            "洛阳市位于中国河南省，是中国著名的文化名城之一。这座城市地处北纬34°，拥有典型的温带季风气候特征。冬季寒冷，夏季炎热，年平均气温约为13.44°C，降水主要集中在夏季。洛阳市的地形以平原为主，四周环绕着山地，这种地形特征与气候相互作用，使得该地区具有明显的季节性气候变化。雨季与干季交替出现，形成独特的气候特征。此外，洛阳拥有悠久的历史和深厚的传统文化，这些都为绿色建筑设计提供了丰富的人文背景。\n\n"
            
            "**被动式策略总述/Overview of Passive Strategy**\n\n"
            "| 被动策略            | 占比     | 定义与适用性                           | 建筑设计中的应用潜力                 |\n"
            "| ------------------- | -------- | ---------------------------------------- | ---------------------------------------- |\n"
            "| 舒适时段            | 3.53%    | 提供自然舒适的居住环境                 | 可通过优化建筑布局和材料选择提升舒适性 |\n"
            "| 窗户遮阳            | 12.33%   | 减少阳光直射引起的室内过热             | 利用遮阳设施降低冷却能耗               |\n"
            "| 高热质量            | 10.75%   | 通过增加材料热容量调节室温             | 确保楼宇内部温度稳定                  |\n"
            "| 高热质量+夜间通风   | 11.47%   | 结合夜间通风和高热质量材料调节室温     | 提高能源利用效率                       |\n"
            "| 直接蒸发冷却        | 6.74%    | 利用水的蒸发作用降低空气温度           | 增加室内舒适性                         |\n"
            "| 双级蒸发冷却        | 4.59%    | 多种冷却方式相结合以提升冷却效率       | 可作为辅助冷却方案                     |\n"
            "| 自然通风冷却        | 14.11%   | 通过自然通风降低室内温度               | 改善居住舒适性并降低能耗               |\n"
            "| 风扇通风冷却        | 15.80%   | 通过风扇提高空气流通，降低室内温度     | 在高温季节效果明显                     |\n"
            "| 内部加热增益        | 21.70%   | 通过内部设备或自然阳光及人活动产生热量 | 应对冬季寒冷非常重要                   |\n"
            "| 仅加湿              | 0.03%    | 单纯对空气进行加湿以适应干燥气候       | 提升居住舒适度                         |\n"
            "| 仅除湿              | 7.23%    | 减少室内湿度以提高舒适性               | 适合潮湿天气                           |\n"
            "| 制冷除湿            | 18.12%   | 集成制冷与除湿，提高环境舒适度         | 降低中央空调能耗                       |\n"
            "| 加热增湿            | 67.08%   | 在冬季提供加热的同时增加空气湿度       | 特别适合冬季使用                       |\n\n"
            
            "**被动式策略详述/Passive Strategy Description**\n\n"
            "在洛阳市，结合当地丰富的文化特色和气候环境，采用被动式建筑策略尤为关键。首先，利用天然材料如土砖和竹子，这不仅能使建筑更好地融入自然环境，还能提高能源利用效率。其次，优化自然通风设计，例如通过科学的计算，使风从建筑的一侧流入并从另一侧流出，从而在炎热的夏季提供凉爽的居住环境。\n\n"
            "控制日照同样重要。采用外遮阳、反射窗或植物遮阳，不仅能防止夏季阳光直射引起的过热，还能在冬季有效地获取太阳热量。此外，通过巧妙的屋顶花园设计，不仅美化环境，还能通过植物蒸发作用降温，提升建筑内部的舒适度。这些策略可以显著提升建筑能效，降低能耗，改善居住体验，使现代建筑与传统文化和谐共存。\n\n"
            
            "**气温环境介绍/Temperature**\n\n"
            "洛阳市气温变化显著，年平均气温为13.44°C，7月最高温度为25.60°C，1月最低温度为-0.55°C。温差较大，意味着建筑设计需考虑四季变化对温度的影响。冬季多数日子需要供暖，而夏季则需冷却。\n\n"
            "应对气温这一挑战，绿色建筑方案可以考虑多种灵活的设计方法。例如，采用高热质量材料，白天吸收热量，夜间再释放，平衡室内温度波动。屋顶设计可采用反射材料，减少夏日阳光直射进入室内，降低空调需求。同时，通过优化建筑朝向和开窗设计，充分利用风的自然流动，确保建筑在变幻多端的气候条件下保持良好的舒适度和能效。\n\n"
            
            "**湿度环境介绍/Humidity**\n\n"
            "洛阳市年平均相对湿度为66.88%，湿度波动较大，尤其在8月和11月时极值明显。湿度的变化对建筑设计有重要影响，高湿环境容易导致室内霉变和空气质量下降，因此，充分考虑湿度因素对材料选择至关重要。\n\n"
            "应对湿度变化的挑战，可引入有效的自然通风与去湿策略。建筑设计应注重优化通风系统，让新鲜空气顺畅流通，减少室内潮湿。使用透气性能良好的建筑材料，可以有效调节室内湿度，提升居住舒适度。此外，设置良好的隔热层，能防止外部湿气进入室内，确保室内环境的健康与舒适。\n\n"
            
            "**风环境介绍/Wind**\n\n"
            "洛阳市年均风速为2.14 m/s，冬季寒风和夏季凉风是主要的盛行风向。不同季节的风速变化为建筑设计提供了良好的通风条件。有效利用自然风，在建筑布局和窗户设计中非常关键，可以降低暖通空调系统的能耗。\n\n"
            "为了应对风环境的挑战，建筑师们可以采用风导向设计，优化建筑形态，利用建筑间的风道效应提升自然通风效率。此外，可以设置风廊和风井，增强自然通风和空气流动，尤其在夏季高温季节，显著提升室内舒适度，减少对空调的依赖。\n\n"
            
            "**天空环境介绍/Sky Cover**\n\n"
            "洛阳市年均天空覆盖率为5.28，夏季天空覆盖量较高，太阳辐射强烈。日照时数的变化趋势推动建筑在设计中采光的优化。通过分析太阳轨迹，设计师可以选择合适的玻璃材料与窗户位置，充分利用自然光。\n\n"
            "应对天空覆盖率变化，建筑设计应强调自然采光的运用。通过利用天窗或大型窗户，引入充足的自然光，减轻人工照明的负担，提升建筑能效。同时，使用反射材料和合理的室内空间布局，让阳光更好地穿透每个房间，营造明亮的居住环境。这不仅符合绿色建筑的原则，还提升了居住者的心理舒适度。"
            
            "**日照辐射介绍/Solar Radiation**\n\n"
            "洛阳市年平均全球辐射水平为174.27 W/m²，其中夏季辐射强度较高，达到6月的最高值249.16 W/m²。这些辐射数据对建筑设计和能源利用有重要影响。\n\n"
            "为了最大化日照的利用，建筑设计应重点考虑建筑朝向与遮阳措施的优化，选择能有效吸收和反射光线的材料。合理布置窗户的位置和大小，既保证充足的阳光进入室内，又避免室内过热的问题。此外，通过屋顶太阳能设备的应用，可以进一步提高建筑的能源自主利用率，助力可持续发展。"

            "**照度介绍/Illumination**\n\n"
            "洛阳市的自然光照年平均值为18859.71 lux，冬季的光照相对较低，这对建筑内部环境和居住舒适度有直接影响。良好的光照不仅能够提升视觉上的舒适感，还会对居住者的心理状态产生积极影响。\n\n"
            "针对这一情况，建筑设计应注重材料的选择和空间布局，确保室内光线均匀分布。利用反射材料和帮助引导光线的设计元素，提升自然采光效果，减少对人工照明的需求。同时，通过科学计算窗户的比例和位置，确保在不同季节中室内能获得充足的自然光照，优化照度从而提升建筑能效和居住舒适度。"




        )
                    
    return get_openai_response(prompt)
